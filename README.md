# Gmail EML Importer

This Node.js application imports `.eml` email files into a specified Gmail label using the IMAP protocol. It processes email files from a designated directory, uploads them to Gmail, and tracks processed files to avoid duplicates. The script includes logging, retry logic for robustness, and a keep-alive mechanism to maintain the IMAP connection.

## Features
- Imports `.eml` files into a Gmail label via IMAP.
- Tracks processed files to prevent re-importing.
- Logs operations to both console and a file for debugging.
- Implements retry logic for handling transient errors.
- Maintains IMAP connection with periodic keep-alive queries.
- Preserves email dates during import.

## Prerequisites
- **Node.js**: Version 14 or higher.
- **Gmail Account**: With IMAP enabled and either:
  - An App-Specific Password (if 2FA is enabled) **OR**
  - OAuth2 credentials (recommended for better security)
- A directory containing `.eml` files to import.
- The target Gmail label created in your Gmail account.

## Installation
1. **Clone the Repository**:
   ```bash
   git clone https://github.com/your-username/gmail-eml-importer.git
   cd gmail-eml-importer
   ```

2. **Install Dependencies**:
   ```bash
   npm install
   ```

3. **Configure the Application**:

   **Option A: Using Environment Variables (Recommended)**

   Copy `.env.example` to `.env` and configure:
   ```bash
   cp .env.example .env
   ```

   Edit `.env` with your settings:
   ```env
   GMAIL_USER=yourname@gmail.com

   # For OAuth2 (recommended):
   OAUTH2_CLIENT_ID=your-client-id.googleusercontent.com
   OAUTH2_CLIENT_SECRET=your-client-secret
   # OAUTH2_REFRESH_TOKEN will be generated by helper script

   # OR for password authentication:
   # GMAIL_PASSWORD=your-app-specific-password

   EML_DIR=/path/to/eml/files/
   GMAIL_LABEL=Imported
   ```

   **Generate OAuth2 Refresh Token (if using OAuth2):**
   ```bash
   npm run generate-oauth2-token
   ```

   **Option B: Editing config.js directly**

   Update the following fields in `src/config.js`:
   - `imap.user`: Your Gmail address (e.g., `yourname@gmail.com`).
   - For **OAuth2** (recommended): Configure `xoauth2` section with Client ID, Client Secret, and Refresh Token.
   - For **password auth**: Use `imap.password` with an App-Specific Password.
   - `emlDir`: Path to the directory containing `.eml` files (e.g., `/path/to/eml/files/`).
   - `gmailLabel`: The Gmail label to import emails into (e.g., `Imported`). Ensure this label exists in Gmail.
   - `logFile`: Path to the log file (e.g., `import_eml_log.txt`).
   - `processedFile`: Path to the file tracking processed `.eml` files (e.g., `processed_eml.txt`).

   **For detailed OAuth2 setup instructions, see [XOAUTH2_SETUP.md](XOAUTH2_SETUP.md)**

## Setup Gmail

### Authentication Methods

**Method 1: OAuth2 (Recommended)**
- More secure, no passwords stored
- Follows modern authentication standards
- Uses secure localhost redirect (replaces deprecated out-of-band flow)
- See detailed setup in [XOAUTH2_SETUP.md](XOAUTH2_SETUP.md)

**Method 2: App-Specific Password**
1. **Enable IMAP**:
   - Go to Gmail Settings > "See all settings" > "Forwarding and POP/IMAP".
   - Enable IMAP under the "IMAP access" section.
2. **Generate an App-Specific Password** (if 2FA is enabled):
   - Go to your Google Account > Security > 2-Step Verification > App passwords.
   - Generate a new password for "Mail" and use it in configuration.

### Common Setup
3. **Create the Target Label**:
   - In Gmail, create the label specified in `gmailLabel` (e.g., `Imported`).

## Usage

1. **Generate OAuth2 Token** (if using OAuth2):
   ```bash
   # Automatic token generation (local/SSH tunnel)
   npm run generate-oauth2-token

   # Or manual process (remote servers)
   npm run generate-auth-url
   ```

2. **Verify Configuration** (recommended):
   ```bash
   npm run check-config
   ```

3. **Test Connection** (optional but recommended):
   ```bash
   npm run test-connection
   ```

4. **Run the Import**:
   ```bash
   npm start
   ```

2. **What Happens**:
   - The script connects to Gmail via IMAP.
   - It reads `.eml` files from the specified `emlDir`.
   - Each `.eml` file is parsed and uploaded to the specified Gmail label.
   - Processed files are logged in `processed_eml.txt` to avoid re-processing.
   - Logs are written to both the console and `import_eml_log.txt`.
   - The script retries up to 100 times on failure, with a 5-second delay between attempts.
   - A keep-alive query runs every 30 seconds to maintain the IMAP connection.

3. **Monitoring**:
   - Check `import_eml_log.txt` for detailed logs, including successes, failures, and errors.
   - The console displays real-time progress, including the number of files processed, successes, and failures.

## File Structure
- `src/index.js`: Main script that handles IMAP connection, file processing, and uploading.
- `src/config.js`: Configuration file for IMAP settings, file paths, and Gmail label.
- `package.json`: Project metadata and dependencies.
- `LICENSE`: MIT License for the project.
- `import_eml_log.txt`: Generated log file (after running the script).
- `processed_eml.txt`: Generated file tracking processed `.eml` files.

## Dependencies
- `dotenv`: Environment variables support for secure configuration.
- `fs-extra`: Enhanced file system operations.
- `googleapis`: Google APIs client library for OAuth2 token generation.
- `imap`: IMAP protocol client for Gmail interaction.
- `mailparser`: Parses `.eml` files to extract email data.
- `moment`: Date parsing (used indirectly via mailparser).
- `winston`: Logging to console and file.
- `xoauth2`: OAuth2 token generation for secure Gmail authentication.

## Troubleshooting
- **IMAP Connection Errors**:
  - **For OAuth2**: Check Client ID, Client Secret, and Refresh Token. See [XOAUTH2_SETUP.md](XOAUTH2_SETUP.md)
  - **For password auth**: Verify `GMAIL_USER` and `GMAIL_PASSWORD` in environment variables or `config.js`.
  - Ensure IMAP is enabled in Gmail settings.
  - If using 2FA with password auth, use an App-Specific Password.
- **OAuth2 Errors**:
  - `invalid_client`: Check Client ID and Client Secret
  - `invalid_grant`: Refresh token may be expired, generate a new one
  - `insufficient_scope`: Ensure proper Gmail API scopes (see XOAUTH2_SETUP.md)
  - `access blocked` or `redirect_uri_mismatch`: Add `http://localhost:3000/callback` to OAuth 2.0 Client redirect URIs in Google Cloud Console
- **Label Not Found**:
  - Ensure the `GMAIL_LABEL` exists in Gmail (case-sensitive).
- **File Not Found**:
  - Check that `EML_DIR` points to a valid directory with `.eml` files.
- **Logs**:
  - Review the log file for detailed error messages including OAuth2 token generation errors.

## Contributing
Contributions are welcome! Please:
1. Fork the repository.
2. Create a feature branch (`git checkout -b feature/your-feature`).
3. Commit your changes (`git commit -m 'Add your feature'`).
4. Push to the branch (`git push origin feature/your-feature`).
5. Open a Pull Request.

## License
This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.

## Author
Erik Kralj, 2025
